<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep Scratchpad</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Doto:wght@700&display=swap" rel="stylesheet">
    
    <!-- Using the production UMD build of Lucide for maximum compatibility -->
    <script src="https://unpkg.com/lucide@0.447.0/dist/umd/lucide.min.js"></script>

    <!-- Legacy Firebase Compat SDKs (Better for local file:// protocol) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .doto-font { font-family: 'Doto', sans-serif; font-weight: 700; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        #note-editor {
            font-size: 1rem;
            color: #000000;
            line-height: 1.5;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #9333ea;
            cursor: pointer;
        }

        /* Explicit Dark Mode Overrides */
        .dark-theme #main-container, .dark-theme #editor-container, .dark-theme #note-editor {
            background-color: #18181b !important;
            color: #f4f4f5 !important;
        }
        .dark-theme #header-bar, .dark-theme #controls-right {
            background-color: #27272a !important;
            border-color: #3f3f46 !important;
        }
        .dark-theme .tab-inactive {
            background-color: #3f3f46 !important;
            color: #a1a1aa !important;
        }
        .dark-theme .tab-active {
            background-color: #18181b !important;
            color: #c084fc !important;
        }
    </style>
</head>
<body class="transition-colors duration-300">
    <div id="app" class="flex flex-col h-screen w-full overflow-hidden">
        <div id="main-container" class="flex flex-col h-full bg-gray-50 text-gray-900 transition-colors duration-300">
            
            <!-- Header / Tabs Bar -->
            <div class="flex items-center w-full bg-gray-200 border-b border-gray-300 px-2 pt-2 gap-2 overflow-x-auto no-scrollbar" id="header-bar">
                <div id="tabs-container" class="flex flex-1 gap-1 overflow-x-auto pb-0 items-center">
                    <!-- Tabs injected here -->
                </div>

                <div class="flex items-center gap-4 bg-gray-200 pb-1 pl-2" id="controls-right">
                    <div class="flex items-center gap-2">
                        <i data-lucide="type" class="w-4 h-4 text-gray-500"></i>
                        <input type="range" id="font-slider" min="12" max="72" value="16" class="w-24 h-1 bg-gray-400 rounded-lg appearance-none cursor-pointer accent-purple-600">
                    </div>
                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-300 text-gray-600 transition-colors">
                        <i data-lucide="moon" id="theme-icon"></i>
                    </button>
                </div>
            </div>

            <!-- Editor Area -->
            <div class="flex-1 relative w-full h-full bg-[#fdfbf7] overflow-hidden transition-colors duration-300" id="editor-container">
                <textarea id="note-editor" class="w-full h-full p-6 resize-none outline-none bg-transparent doto-font placeholder-gray-400" placeholder="Type something here..." spellcheck="false"></textarea>
                
                <div id="ai-loading" class="hidden absolute bottom-4 right-4 bg-purple-600 text-white px-4 py-2 rounded-full shadow-lg flex items-center gap-2 animate-bounce z-50">
                    <i data-lucide="loader-2" class="animate-spin w-4 h-4"></i>
                    <span class="text-sm font-bold">Making magic happen...</span>
                </div>
            </div>

            <!-- Bottom Toolbar -->
            <div class="flex items-center justify-between px-6 py-4 bg-gray-100 border-t border-gray-200 relative">
                <div class="relative">
                    <div id="magic-menu" class="hidden absolute bottom-12 left-0 bg-white border border-purple-200 rounded-xl shadow-2xl p-2 flex flex-col gap-1 w-48 z-10">
                        <button id="btn-fix" class="flex items-center gap-2 px-3 py-2 hover:bg-purple-50 rounded-lg text-sm text-gray-700 text-left">
                            <i data-lucide="wand-2" class="w-4 h-4 text-purple-500"></i> Fix Grammar ✨
                        </button>
                        <button id="btn-continue" class="flex items-center gap-2 px-3 py-2 hover:bg-purple-50 rounded-lg text-sm text-gray-700 text-left">
                            <i data-lucide="pen-line" class="w-4 h-4 text-blue-500"></i> Continue Writing ✨
                        </button>
                        <button id="btn-summarize" class="flex items-center gap-2 px-3 py-2 hover:bg-purple-50 rounded-lg text-sm text-gray-700 text-left">
                            <i data-lucide="file-text" class="w-4 h-4 text-green-500"></i> Summarize ✨
                        </button>
                    </div>
                    <button id="magic-btn" class="flex items-center justify-center gap-2 h-10 w-32 rounded-lg transition-all font-medium text-sm shadow-sm bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white">
                        <i data-lucide="sparkles" class="w-4 h-4"></i> Magic ✨
                    </button>
                </div>

                <div class="flex gap-4">
                    <button id="clear-btn" class="flex items-center justify-center gap-2 h-10 w-32 rounded-lg transition-all font-medium text-sm shadow-sm bg-red-100 text-red-600 hover:bg-red-200">
                        <i data-lucide="trash-2" class="w-4 h-4"></i> Clear
                    </button>
                    <button id="copy-btn" class="flex items-center justify-center gap-2 h-10 w-32 rounded-lg transition-all font-medium text-sm shadow-sm bg-gray-200 text-gray-700 hover:bg-gray-300">
                        <i data-lucide="copy" id="copy-icon" class="w-4 h-4"></i> <span id="copy-text">Copy</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Use Global Firebase Objects (Compat Version)
        const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
        const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
        const apiKey = ""; // Gemini API Key

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // App State
        let notes = [];
        let activeNoteId = null;
        let darkMode = false;
        let currentUser = null;

        // UI Selectors
        const tabsContainer = document.getElementById('tabs-container');
        const editor = document.getElementById('note-editor');
        const fontSlider = document.getElementById('font-slider');
        const themeToggle = document.getElementById('theme-toggle');
        const mainContainer = document.getElementById('main-container');
        const magicBtn = document.getElementById('magic-btn');
        const magicMenu = document.getElementById('magic-menu');
        const aiLoading = document.getElementById('ai-loading');

        // Initial Auth
        auth.signInAnonymously().catch(err => console.error("Auth error:", err));

        auth.onAuthStateChanged((user) => {
            currentUser = user;
            if (user) {
                setupRealtimeSync();
            }
        });

        function setupRealtimeSync() {
            const notesPath = `artifacts/${appId}/users/${currentUser.uid}/notes`;
            db.collection(notesPath).orderBy('createdAt', 'desc').onSnapshot((snapshot) => {
                notes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                if (notes.length === 0) {
                    createNewNote();
                } else if (!activeNoteId || !notes.find(n => n.id === activeNoteId)) {
                    activeNoteId = notes[0].id;
                }
                
                renderTabs();
                renderEditor();
            });
        }

        function createNewNote() {
            const notesPath = `artifacts/${appId}/users/${currentUser.uid}/notes`;
            db.collection(notesPath).add({
                content: "",
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        function deleteNote(id) {
            const notesPath = `artifacts/${appId}/users/${currentUser.uid}/notes`;
            db.collection(notesPath).doc(id).delete();
        }

        function renderTabs() {
            tabsContainer.innerHTML = '';
            notes.forEach((note) => {
                const isActive = activeNoteId === note.id;
                const tab = document.createElement('div');
                
                const themeClasses = isActive 
                    ? 'tab-active' 
                    : 'tab-inactive bg-gray-300 text-gray-600 hover:bg-gray-200';

                tab.className = `group flex items-center gap-2 px-4 py-2 rounded-t-lg cursor-pointer select-none min-w-[120px] max-w-[200px] h-10 transition-all duration-200 ${themeClasses} ${isActive ? 'shadow-sm font-bold' : ''}`;
                
                const displayTitle = note.content.trim() === "" ? "New Note" : (note.content.substring(0, 12) + "...");
                
                tab.innerHTML = `
                    <span class="truncate flex-1 text-sm">${displayTitle}</span>
                    <button class="opacity-0 group-hover:opacity-100 p-1 hover:bg-red-500 hover:text-white rounded-full transition-all del-btn">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>
                `;
                
                tab.onclick = () => { activeNoteId = note.id; renderTabs(); renderEditor(); };
                tab.querySelector('.del-btn').onclick = (e) => { e.stopPropagation(); deleteNote(note.id); };
                tabsContainer.appendChild(tab);
            });

            const addBtn = document.createElement('button');
            addBtn.className = "flex items-center justify-center p-2 rounded-t-lg bg-gray-300 hover:bg-gray-200 text-gray-600 h-10 w-10 transition-colors dark:bg-zinc-800 dark:hover:bg-zinc-700";
            addBtn.innerHTML = '<i data-lucide="plus" class="w-4 h-4"></i>';
            addBtn.onclick = createNewNote;
            tabsContainer.appendChild(addBtn);
            
            lucide.createIcons();
        }

        function renderEditor() {
            const activeNote = notes.find(n => n.id === activeNoteId);
            editor.value = activeNote ? activeNote.content : '';
        }

        // Input & Controls
        editor.oninput = (e) => {
            if (!currentUser || !activeNoteId) return;
            const content = e.target.value;
            const notesPath = `artifacts/${appId}/users/${currentUser.uid}/notes`;
            db.collection(notesPath).doc(activeNoteId).update({ content });
        };

        fontSlider.oninput = (e) => {
            editor.style.fontSize = e.target.value + 'px';
        };

        themeToggle.onclick = () => {
            darkMode = !darkMode;
            document.body.classList.toggle('dark-theme', darkMode);
            const icon = document.getElementById('theme-icon');
            icon.setAttribute('data-lucide', darkMode ? 'sun' : 'moon');
            renderTabs(); // Refresh tab colors
            lucide.createIcons();
        };

        // Magic Functions
        async function handleMagic(action) {
            const activeNote = notes.find(n => n.id === activeNoteId);
            if (!activeNote || !activeNote.content.trim()) return;

            aiLoading.classList.remove('hidden');
            magicMenu.classList.add('hidden');

            const prompts = {
                summarize: `Summarize this text concisely:\n\n${activeNote.content}`,
                continue: `Continue this text naturally:\n\n${activeNote.content}`,
                fix: `Fix grammar/spelling, return ONLY the corrected text:\n\n${activeNote.content}`
            };

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompts[action] }] }] })
                });
                const data = await response.json();
                const result = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
                
                let newContent = activeNote.content;
                if (action === 'fix') newContent = result;
                else if (action === 'summarize') newContent += `\n\n✨ SUMMARY ✨\n${result}`;
                else newContent += (activeNote.content.endsWith(' ') ? '' : ' ') + result;

                const notesPath = `artifacts/${appId}/users/${currentUser.uid}/notes`;
                await db.collection(notesPath).doc(activeNoteId).update({ content: newContent });
            } catch (err) {
                console.error("Magic error:", err);
            } finally {
                aiLoading.classList.add('hidden');
            }
        }

        // Attach listeners
        document.getElementById('btn-fix').onclick = () => handleMagic('fix');
        document.getElementById('btn-continue').onclick = () => handleMagic('continue');
        document.getElementById('btn-summarize').onclick = () => handleMagic('summarize');
        magicBtn.onclick = (e) => { e.stopPropagation(); magicMenu.classList.toggle('hidden'); };
        window.onclick = () => magicMenu.classList.add('hidden');

        document.getElementById('clear-btn').onclick = () => {
            editor.value = '';
            editor.dispatchEvent(new Event('input'));
        };

        document.getElementById('copy-btn').onclick = () => {
            editor.select();
            document.execCommand('copy');
            const btn = document.getElementById('copy-btn');
            const icon = document.getElementById('copy-icon');
            const text = document.getElementById('copy-text');
            
            btn.classList.replace('bg-gray-200', 'bg-green-500');
            btn.classList.add('text-white');
            text.innerText = 'Copied!';
            icon.setAttribute('data-lucide', 'check');
            lucide.createIcons();
            
            setTimeout(() => {
                btn.classList.replace('bg-green-500', 'bg-gray-200');
                btn.classList.remove('text-white');
                text.innerText = 'Copy';
                icon.setAttribute('data-lucide', 'copy');
                lucide.createIcons();
            }, 2000);
        };

        // Initialize Icons
        window.onload = () => lucide.createIcons();
    </script>
</body>
</html>