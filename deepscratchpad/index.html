<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep Scratchpad</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Doto:wght@700&display=swap" rel="stylesheet">
    <!-- Load Lucide icons from a reliable CDN -->
    <script src="https://unpkg.com/lucide@0.447.0/dist/umd/lucide.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .doto-font { font-family: 'Doto', sans-serif; font-weight: 700; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Default text size and color for light mode */
        #note-editor {
            font-size: 1rem;
            color: #000000;
        }

        /* Range slider styling */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #9333ea;
            cursor: pointer;
        }

        /* Dark mode overrides */
        .dark #note-editor {
            color: #f3f4f6;
        }
    </style>
</head>
<body class="transition-colors duration-300">
    <div id="app" class="flex flex-col h-screen w-full overflow-hidden">
        <div id="main-container" class="flex flex-col h-full bg-gray-50 text-gray-900 transition-colors duration-300">
            
            <!-- Header / Tabs Bar -->
            <div class="flex items-center w-full bg-gray-200 border-b border-gray-300 px-2 pt-2 gap-2 overflow-x-auto no-scrollbar" id="header-bar">
                <div id="tabs-container" class="flex flex-1 gap-1 overflow-x-auto pb-0 items-center">
                    <!-- Tabs injected here -->
                </div>

                <div class="flex items-center gap-4 bg-gray-200 pb-1 pl-2" id="controls-right">
                    <div class="flex items-center gap-2" title="Adjust Font Size">
                        <i data-lucide="type" class="w-4 h-4 text-gray-500"></i>
                        <input type="range" id="font-slider" min="12" max="72" value="16" class="w-24 h-1 bg-gray-400 rounded-lg appearance-none cursor-pointer accent-purple-600">
                    </div>
                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-300 text-gray-600 transition-colors">
                        <i data-lucide="moon" id="theme-icon"></i>
                    </button>
                </div>
            </div>

            <!-- Editor Area -->
            <div class="flex-1 relative w-full h-full bg-[#fdfbf7] overflow-hidden transition-colors duration-300" id="editor-container">
                <textarea id="note-editor" class="w-full h-full p-6 resize-none outline-none bg-transparent doto-font placeholder-gray-400" placeholder="Type something here..." spellcheck="false"></textarea>
                
                <div id="ai-loading" class="hidden absolute bottom-4 right-4 bg-purple-600 text-white px-4 py-2 rounded-full shadow-lg flex items-center gap-2 animate-bounce">
                    <i data-lucide="loader-2" class="animate-spin w-4 h-4"></i>
                    <span class="text-sm font-bold">Making magic happen...</span>
                </div>
            </div>

            <!-- Bottom Toolbar -->
            <div class="flex items-center justify-between px-6 py-4 bg-gray-100 border-t border-gray-200 relative">
                <!-- Left Side: Magic -->
                <div class="relative">
                    <div id="magic-menu" class="hidden absolute bottom-12 left-0 bg-white border border-purple-200 rounded-xl shadow-2xl p-2 flex flex-col gap-1 w-48 z-10">
                        <button id="btn-fix" class="flex items-center gap-2 px-3 py-2 hover:bg-purple-50 rounded-lg text-sm text-gray-700 text-left">
                            <i data-lucide="wand-2" class="w-4 h-4 text-purple-500"></i> Fix Grammar ✨
                        </button>
                        <button id="btn-continue" class="flex items-center gap-2 px-3 py-2 hover:bg-purple-50 rounded-lg text-sm text-gray-700 text-left">
                            <i data-lucide="pen-line" class="w-4 h-4 text-blue-500"></i> Continue Writing ✨
                        </button>
                        <button id="btn-summarize" class="flex items-center gap-2 px-3 py-2 hover:bg-purple-50 rounded-lg text-sm text-gray-700 text-left">
                            <i data-lucide="file-text" class="w-4 h-4 text-green-500"></i> Summarize ✨
                        </button>
                    </div>
                    <button id="magic-btn" class="flex items-center justify-center gap-2 h-10 w-32 rounded-lg transition-all font-medium text-sm shadow-sm bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white">
                        <i data-lucide="sparkles" class="w-4 h-4"></i> Magic ✨
                    </button>
                </div>

                <!-- Right Side: Clear & Copy -->
                <div class="flex gap-4">
                    <button id="clear-btn" class="flex items-center justify-center gap-2 h-10 w-32 rounded-lg transition-all font-medium text-sm shadow-sm bg-red-100 text-red-600 hover:bg-red-200">
                        <i data-lucide="trash-2" class="w-4 h-4"></i> Clear
                    </button>
                    <button id="copy-btn" class="flex items-center justify-center gap-2 h-10 w-32 rounded-lg transition-all font-medium text-sm shadow-sm bg-gray-200 text-gray-700 hover:bg-gray-300">
                        <i data-lucide="copy" id="copy-icon" class="w-4 h-4"></i> <span id="copy-text">Copy</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs & App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, onSnapshot, deleteDoc, serverTimestamp, query } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // Configuration
        const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
        const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
        const apiKey = ""; // Gemini API Key provided at runtime

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State Management
        let notes = [];
        let activeNoteId = null;
        let darkMode = false;
        let user = null;

        // UI Selectors
        const tabsContainer = document.getElementById('tabs-container');
        const editor = document.getElementById('note-editor');
        const fontSlider = document.getElementById('font-slider');
        const themeToggle = document.getElementById('theme-toggle');
        const mainContainer = document.getElementById('main-container');
        const editorContainer = document.getElementById('editor-container');
        const magicBtn = document.getElementById('magic-btn');
        const magicMenu = document.getElementById('magic-menu');
        const aiLoading = document.getElementById('ai-loading');

        // Initial Icon Rendering
        lucide.createIcons();

        // 1. Authentication
        async function initAuth() {
            try {
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (u) => {
                    user = u;
                    if (user) startNotesSync();
                });
            } catch (err) {
                console.error("Auth failed:", err);
            }
        }

        // 2. Data Synchronization
        function startNotesSync() {
            const notesRef = collection(db, 'artifacts', appId, 'users', user.uid, 'notes');
            onSnapshot(notesRef, (snapshot) => {
                notes = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                notes.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                
                if (notes.length === 0) {
                    createNewNote();
                } else if (!activeNoteId || !notes.find(n => n.id === activeNoteId)) {
                    activeNoteId = notes[0].id;
                }
                
                renderTabs();
                renderEditor();
            }, (err) => console.error("Snapshot error:", err));
        }

        async function createNewNote() {
            if (!user) return;
            const notesRef = collection(db, 'artifacts', appId, 'users', user.uid, 'notes');
            await addDoc(notesRef, { 
                content: "", 
                createdAt: serverTimestamp() 
            });
        }

        async function deleteNote(id) {
            if (!user) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'notes', id));
        }

        // 3. UI Rendering
        function renderTabs() {
            tabsContainer.innerHTML = '';
            notes.forEach((note) => {
                const isActive = activeNoteId === note.id;
                const tab = document.createElement('div');
                tab.className = `group flex items-center gap-2 px-4 py-2 rounded-t-lg cursor-pointer select-none min-w-[120px] max-w-[200px] h-10 transition-all duration-200 ${isActive ? (darkMode ? 'bg-zinc-900 text-purple-400' : 'bg-[#fdfbf7] text-purple-600 shadow-sm') : (darkMode ? 'bg-zinc-700 text-gray-400' : 'bg-gray-300 text-gray-600')}`;
                
                const titleText = note.content.trim() === "" ? "New Note" : (note.content.substring(0, 12) + "...");
                
                tab.innerHTML = `
                    <span class="truncate flex-1 text-sm font-bold">${titleText}</span>
                    <button class="opacity-0 group-hover:opacity-100 p-1 hover:bg-red-500 hover:text-white rounded-full transition-all del-btn">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>
                `;
                
                tab.onclick = () => { activeNoteId = note.id; renderTabs(); renderEditor(); };
                tab.querySelector('.del-btn').onclick = (e) => { e.stopPropagation(); deleteNote(note.id); };
                tabsContainer.appendChild(tab);
            });

            // Plus button
            const addBtn = document.createElement('button');
            addBtn.className = "flex items-center justify-center p-2 rounded-t-lg bg-gray-300 hover:bg-gray-200 text-gray-600 h-10 w-10 transition-colors";
            addBtn.innerHTML = '<i data-lucide="plus" class="w-4 h-4"></i>';
            addBtn.onclick = createNewNote;
            tabsContainer.appendChild(addBtn);
            
            lucide.createIcons();
        }

        function renderEditor() {
            const activeNote = notes.find(n => n.id === activeNoteId);
            editor.value = activeNote ? activeNote.content : '';
        }

        // 4. Interaction Handlers
        editor.oninput = (e) => {
            if (!user || !activeNoteId) return;
            const content = e.target.value;
            const noteRef = doc(db, 'artifacts', appId, 'users', user.uid, 'notes', activeNoteId);
            updateDoc(noteRef, { content }).catch(console.error);
        };

        fontSlider.oninput = (e) => {
            editor.style.fontSize = e.target.value + 'px';
        };

        themeToggle.onclick = () => {
            darkMode = !darkMode;
            document.documentElement.classList.toggle('dark', darkMode);
            mainContainer.classList.toggle('bg-zinc-900', darkMode);
            mainContainer.classList.toggle('text-gray-100', darkMode);
            mainContainer.classList.toggle('bg-gray-50', !darkMode);
            editorContainer.classList.toggle('bg-zinc-900', darkMode);
            editorContainer.classList.toggle('bg-[#fdfbf7]', !darkMode);
            
            const icon = document.getElementById('theme-icon');
            icon.setAttribute('data-lucide', darkMode ? 'sun' : 'moon');
            lucide.createIcons();
        };

        // 5. Magic AI logic
        async function handleMagic(action) {
            const activeNote = notes.find(n => n.id === activeNoteId);
            if (!activeNote || !activeNote.content.trim()) return;

            aiLoading.classList.remove('hidden');
            magicMenu.classList.add('hidden');

            let prompt = "";
            if (action === 'summarize') prompt = `Summarize the following text concisely:\n\n${activeNote.content}`;
            else if (action === 'continue') prompt = `Continue writing the following text naturally:\n\n${activeNote.content}`;
            else if (action === 'fix') prompt = `Fix grammar and spelling for this text, return only the corrected text:\n\n${activeNote.content}`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                const result = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
                
                let newContent = activeNote.content;
                if (action === 'fix') newContent = result;
                else if (action === 'summarize') newContent += `\n\n✨ SUMMARY ✨\n${result}`;
                else newContent += (activeNote.content.endsWith(' ') ? '' : ' ') + result;

                const noteRef = doc(db, 'artifacts', appId, 'users', user.uid, 'notes', activeNoteId);
                await updateDoc(noteRef, { content: newContent });
            } catch (err) {
                console.error("AI Error:", err);
            } finally {
                aiLoading.classList.add('hidden');
            }
        }

        // Attachment of magic events
        document.getElementById('btn-fix').onclick = () => handleMagic('fix');
        document.getElementById('btn-continue').onclick = () => handleMagic('continue');
        document.getElementById('btn-summarize').onclick = () => handleMagic('summarize');

        magicBtn.onclick = (e) => { e.stopPropagation(); magicMenu.classList.toggle('hidden'); };
        window.onclick = () => magicMenu.classList.add('hidden');

        document.getElementById('clear-btn').onclick = () => {
            editor.value = '';
            editor.dispatchEvent(new Event('input'));
        };

        document.getElementById('copy-btn').onclick = async () => {
            try {
                await navigator.clipboard.writeText(editor.value);
            } catch (e) {
                editor.select();
                document.execCommand('copy');
            }
            const btn = document.getElementById('copy-btn');
            const icon = document.getElementById('copy-icon');
            const text = document.getElementById('copy-text');
            
            const originalClasses = btn.className;
            btn.className = "flex items-center justify-center gap-2 h-10 w-32 rounded-lg transition-all font-medium text-sm shadow-sm bg-green-500 text-white";
            text.innerText = 'Copied!';
            icon.setAttribute('data-lucide', 'check');
            lucide.createIcons();
            
            setTimeout(() => {
                btn.className = originalClasses;
                text.innerText = 'Copy';
                icon.setAttribute('data-lucide', 'copy');
                lucide.createIcons();
            }, 2000);
        };

        // Initialize Everything
        window.onload = () => {
            initAuth();
            lucide.createIcons();
        };
    </script>
</body>
</html>